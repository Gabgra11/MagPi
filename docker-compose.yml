services:
  listener:
    build:
      context: ./listener
      dockerfile: Dockerfile
    container_name: magpi-listener
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - /dev/snd:/dev/snd
    devices:
      - /dev/snd
    environment:
      - LISTENER_ENABLED=${LISTENER_ENABLED:-true}
      - LISTENER_DB_PATH=${LISTENER_DB_PATH:-/app/data/detections.db}
      - LISTENER_AUDIO_DEVICE=${LISTENER_AUDIO_DEVICE:--1}
      - LISTENER_SAMPLE_RATE=${LISTENER_SAMPLE_RATE:-48000}
      - LISTENER_CHUNK_SIZE=${LISTENER_CHUNK_SIZE:-2048}
      - LISTENER_BUFFER_DURATION=${LISTENER_BUFFER_DURATION:-10}
      - LISTENER_SAMPLE_DURATION=${LISTENER_SAMPLE_DURATION:-5}
      - LISTENER_MIN_CONFIDENCE=${LISTENER_MIN_CONFIDENCE:-0.5}
      - LISTENER_DUPLICATE_WINDOW=${LISTENER_DUPLICATE_WINDOW:-30}
      - LISTENER_NUM_WORKERS=${LISTENER_NUM_WORKERS:-2}
      - LISTENER_LOG_LEVEL=${LISTENER_LOG_LEVEL:-INFO}
      - BIRDNET_THREADS=${BIRDNET_THREADS:-4}
      - BIRDNET_GPU=${BIRDNET_GPU:-false}
      - BIRDNET_LOCATION_LAT=${BIRDNET_LOCATION_LAT:-40.7128}
      - BIRDNET_LOCATION_LON=${BIRDNET_LOCATION_LON:--74.0060}
    ports:
      - "8000:8000"
    networks:
      - magpi-network

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: magpi-dashboard
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - DASHBOARD_PORT=${DASHBOARD_PORT:-3000}
      - DASHBOARD_HOST=${DASHBOARD_HOST:-0.0.0.0}
      - DASHBOARD_API_URL=${DASHBOARD_API_URL:-http://listener:8000}
      - DASHBOARD_UPDATE_INTERVAL=${DASHBOARD_UPDATE_INTERVAL:-5000}
      - API_CORS_ORIGIN=${API_CORS_ORIGIN:-*}
      - DASHBOARD_LOG_LEVEL=${DASHBOARD_LOG_LEVEL:-info}
    ports:
      - "3000:3000"
    depends_on:
      - listener
    networks:
      - magpi-network

networks:
  magpi-network:
    driver: bridge

volumes:
  data:
